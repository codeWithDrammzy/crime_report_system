{% extends "crime_app/officerPage/main.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

<!-- ===================== Page Container ===================== -->
<div class="bg-gray-100 p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200">

    <!-- ‚úÖ Header Buttons -->
    <div class="flex justify-between items-center bg-blue-600 text-white px-6 py-4">
      <h1 class="text-2xl font-bold tracking-wide">Crime Reports</h1>

      <div class="space-x-3">
        <button id="showTableBtn"
          class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition">
          üìã View Reports
        </button>
        <button id="showFormBtn"
          class="bg-blue-700 text-white hover:bg-blue-800 px-4 py-2 rounded-lg shadow transition">
          üìù New Report
        </button>
      </div>
    </div>

    <!-- ===================== Reports Table Section ===================== -->
    <div id="reportTableSection" class="p-6 overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-4 py-3 font-semibold text-gray-600">#</th>
            <th class="px-4 py-3 font-semibold text-gray-600">Title</th>
            <th class="px-4 py-3 font-semibold text-gray-600">Department</th>
            <th class="px-4 py-3 font-semibold text-gray-600">Status</th>
            <th class="px-4 py-3 font-semibold text-gray-600">Date</th>
            <th class="px-4 py-3 font-semibold text-gray-600">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for report in reports %}
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3">{{ forloop.counter }}</td>
            <td class="px-4 py-3 font-medium text-gray-800">{{ report.title }}</td>
            <td class="px-4 py-3">{{ report.department.name }}</td>
            <td class="px-4 py-3">
              <span
                class="px-2 py-1 rounded-full text-xs font-semibold {% if report.status == 'Pending' %}bg-yellow-100 text-yellow-700{% elif report.status == 'Resolved' %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ report.status }}
              </span>
            </td>
            <td class="px-4 py-3 text-gray-600">{{ report.date_reported|date:"M d, Y" }}</td>
            <td class="px-4 py-3">
              <a href="{% url 'report-detail' report.id %}"
                class="text-blue-600 hover:underline font-medium">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center py-6 text-gray-500">No reports available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===================== Report Form Section ===================== -->
  <div id="reportFormSection" class="hidden min-h-[80vh] flex flex-col justify-center items-center bg-gray-50 p-10">
    <div class="w-full max-w-6xl bg-white p-8 rounded-2xl shadow-md border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìù Submit New Crime Report</h2>

      <form method="POST" enctype="multipart/form-data" class="space-y-5">
        {% csrf_token %}
        
        <!-- Two-column form layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Left Column -->
          <div class="space-y-4">
            {% for field in form %}
              {% if forloop.counter0|divisibleby:2 %}  <!-- Even indices (0, 2, 4...) -->
                <div class="form-group">
                  <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ field.label }}
                    {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                  </label>
                  
                  {% if field.name == "department" or field.name == "incident_type" %}
                    <!-- Select field for department and incident_type -->
                    <select name="{{ field.name }}" 
                            id="{{ field.id_for_label }}" 
                            class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            {% if field.field.required %}required{% endif %}>
                      <option value="">Select {{ field.label }}</option>
                      {% for choice in field.field.choices %}
                        {% if choice.0 != '' %}
                          <option value="{{ choice.0 }}" {% if field.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                            {{ choice.1 }}
                          </option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  {% else %}
                    <!-- Regular input field -->
                    <input type="{{ field.field.widget.input_type }}" 
                          name="{{ field.name }}" 
                          id="{{ field.id_for_label }}" 
                          class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          value="{{ field.value|default:'' }}"
                          {% if field.field.required %}required{% endif %}>
                  {% endif %}
                  
                  {% if field.help_text %}
                    <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                  {% endif %}
                  {% for error in field.errors %}
                    <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
          
          <!-- Right Column -->
          <div class="space-y-4">
            {% for field in form %}
              {% if not forloop.counter0|divisibleby:2 %}  <!-- Odd indices (1, 3, 5...) -->
                <div class="form-group">
                  <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ field.label }}
                    {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                  </label>
                  
                  {% if field.name == "department" or field.name == "incident_type" %}
                    <!-- Select field for department and incident_type -->
                    <select name="{{ field.name }}" 
                            id="{{ field.id_for_label }}" 
                            class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            {% if field.field.required %}required{% endif %}>
                      <option value="">Select {{ field.label }}</option>
                      {% for choice in field.field.choices %}
                        {% if choice.0 != '' %}
                          <option value="{{ choice.0 }}" {% if field.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                            {{ choice.1 }}
                          </option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  {% else %}
                    <!-- Regular input field -->
                    <input type="{{ field.field.widget.input_type }}" 
                          name="{{ field.name }}" 
                          id="{{ field.id_for_label }}" 
                          class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          value="{{ field.value|default:'' }}"
                          {% if field.field.required %}required{% endif %}>
                  {% endif %}
                  
                  {% if field.help_text %}
                    <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                  {% endif %}
                  {% for error in field.errors %}
                    <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- ‚úÖ Multimedia Evidence Section (Full width) -->
        <div class="border-t pt-6 mt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">üì∑ Multimedia Evidence</h3>

            <!-- Three columns in one line -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Photo Capture Column -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center h-full">
                    <h4 class="font-semibold text-gray-700 mb-3">üì∏ Photo</h4>
                    <video id="cameraPreview" class="mx-auto rounded-md hidden w-full max-w-xs" autoplay></video>
                    <canvas id="photoCanvas" class="hidden"></canvas>
                    <div id="photoPreviewContainer" class="my-3"></div>

                    <div class="space-y-2">
                        <button type="button" id="openCameraBtn"
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Open Camera
                        </button>
                        <button type="button" id="takePhotoBtn"
                            class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Take Photo
                        </button>
                    </div>

                    <input type="file" name="photo_file" id="photoFileInput" accept="image/*" class="hidden" />
                </div>

                <!-- Video Recording Column -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center h-full">
                    <h4 class="font-semibold text-gray-700 mb-3">üé• Video</h4>
                    <video id="videoPreview" class="mx-auto rounded-md hidden w-full max-w-xs" controls></video>
                    
                    <div class="space-y-2">
                        <button type="button" id="startVideoBtn"
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Start Recording
                        </button>
                        <button type="button" id="stopVideoBtn"
                            class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Stop Recording
                        </button>
                    </div>

                    <input type="file" name="video_file" id="videoFileInput" accept="video/*" class="hidden" />
                </div>

                <!-- Audio Recording Column -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center h-full">
                    <h4 class="font-semibold text-gray-700 mb-3">üé§ Audio</h4>
                    <audio id="audioPreview" class="mx-auto hidden w-full" controls></audio>
                    
                    <div class="space-y-2">
                        <button type="button" id="startAudioBtn"
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Record Voice
                        </button>
                        <button type="button" id="stopAudioBtn"
                            class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow text-sm w-full">
                            Stop
                        </button>
                    </div>

                    <input type="file" name="audio_file" id="audioFileInput" accept="audio/*" class="hidden" />
                </div>
            </div>
        </div>
        <!-- Submit Buttons -->
        <div class="flex justify-center space-x-4 mt-8">
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition">
            Submit Report
          </button>
          <button type="button" id="cancelFormBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  </div>
</div>

<!-- ===================== Script Section ===================== -->
<script>
  const formSection = document.getElementById('reportFormSection');
  const tableSection = document.getElementById('reportTableSection');
  const showFormBtn = document.getElementById('showFormBtn');
  const showTableBtn = document.getElementById('showTableBtn');
  const cancelFormBtn = document.getElementById('cancelFormBtn');

  // Toggle sections
  showFormBtn.onclick = () => {
    formSection.classList.remove('hidden');
    tableSection.classList.add('hidden');
  };
  showTableBtn.onclick = () => {
    formSection.classList.add('hidden');
    tableSection.classList.remove('hidden');
  };
  cancelFormBtn.onclick = () => showTableBtn.click();

  // ======== CAMERA (Photo Capture) =========
  const openCameraBtn = document.getElementById('openCameraBtn');
  const takePhotoBtn = document.getElementById('takePhotoBtn');
  const cameraPreview = document.getElementById('cameraPreview');
  const photoCanvas = document.getElementById('photoCanvas');
  const photoFileInput = document.getElementById('photoFileInput');
  const photoPreviewContainer = document.getElementById('photoPreviewContainer');
  let cameraStream;

  openCameraBtn.onclick = async () => {
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
    cameraPreview.srcObject = cameraStream;
    cameraPreview.classList.remove('hidden');
    takePhotoBtn.classList.remove('hidden');
    openCameraBtn.classList.add('hidden');
  };

  takePhotoBtn.onclick = () => {
    const context = photoCanvas.getContext('2d');
    photoCanvas.width = cameraPreview.videoWidth;
    photoCanvas.height = cameraPreview.videoHeight;
    context.drawImage(cameraPreview, 0, 0);
    photoCanvas.toBlob(blob => {
      const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      photoFileInput.files = dataTransfer.files;

      // preview
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.classList.add('mx-auto', 'rounded-md', 'mt-3', 'max-h-56');
      photoPreviewContainer.innerHTML = '';
      photoPreviewContainer.appendChild(img);
    }, 'image/jpeg');
  };

  // ======== VIDEO RECORDING =========
  const startVideoBtn = document.getElementById('startVideoBtn');
  const stopVideoBtn = document.getElementById('stopVideoBtn');
  const videoPreview = document.getElementById('videoPreview');
  const videoFileInput = document.getElementById('videoFileInput');
  let videoRecorder, videoChunks = [];

  startVideoBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    videoRecorder = new MediaRecorder(stream);
    videoChunks = [];

    videoRecorder.ondataavailable = e => videoChunks.push(e.data);
    videoRecorder.onstop = () => {
      const blob = new Blob(videoChunks, { type: 'video/mp4' });
      const file = new File([blob], 'recording.mp4', { type: 'video/mp4' });
      const dt = new DataTransfer();
      dt.items.add(file);
      videoFileInput.files = dt.files;

      videoPreview.src = URL.createObjectURL(blob);
      videoPreview.classList.remove('hidden');
    };

    videoRecorder.start();
    startVideoBtn.classList.add('hidden');
    stopVideoBtn.classList.remove('hidden');
  };

  stopVideoBtn.onclick = () => {
    videoRecorder.stop();
    startVideoBtn.classList.remove('hidden');
    stopVideoBtn.classList.add('hidden');
  };

  // ======== AUDIO RECORDING =========
  const startAudioBtn = document.getElementById('startAudioBtn');
  const stopAudioBtn = document.getElementById('stopAudioBtn');
  const audioPreview = document.getElementById('audioPreview');
  const audioFileInput = document.getElementById('audioFileInput');
  let audioRecorder, audioChunks = [];

  startAudioBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioRecorder = new MediaRecorder(stream);
    audioChunks = [];

    audioRecorder.ondataavailable = e => audioChunks.push(e.data);
    audioRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: 'audio/mp3' });
      const file = new File([blob], 'voice.mp3', { type: 'audio/mp3' });
      const dt = new DataTransfer();
      dt.items.add(file);
      audioFileInput.files = dt.files;

      audioPreview.src = URL.createObjectURL(blob);
      audioPreview.classList.remove('hidden');
    };

    audioRecorder.start();
    startAudioBtn.classList.add('hidden');
    stopAudioBtn.classList.remove('hidden');
  };

  stopAudioBtn.onclick = () => {
    audioRecorder.stop();
    startAudioBtn.classList.remove('hidden');
    stopAudioBtn.classList.add('hidden');
  };
</script>

{% endblock %}